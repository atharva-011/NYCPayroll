# Data

```{r message=FALSE, warning=FALSE}
# Importing Necessary Libraries
library(knitr)
library(redav)
library(mi)
library(ggplot2)
library(data.table)
library(dplyr)
```

## Technical Description

The data that we will be using to analyze Payroll Data is from the NYC Open Data [website](https://opendata.cityofnewyork.us/) and is titled as  [**Citywide Payroll Data (Fiscal Year)**](https://data.cityofnewyork.us/City-Government/Citywide-Payroll-Data-Fiscal-Year-/k397-673e). The data set was created back in 2015 and has been constantly been updated on a annual basis (last update was on November 28,2023). It tells us about the amount of money spent on salaries and overtime pay for all municipal employees based in New York City. The data is provided by **Office of Payroll Administration (OPA)**. 

The data can be downloaded as a CSV file from the website mentioned above. The entirety of the dataset consists of 5.66 million rows (essentially 5.66 million municipal employees) and 17 columns. Every row basically tells us about the employee salary, their work location, agency, base pay, overtime (if any), etc. 

However, the dataset is too large for efficient processing. Hence, we randomly sample our data and retrieve 10000 samples for our analysis. The code for the same can be found below, but has been commented out, as such large files cannot be uploaded to GitHub, and rendering will be affected.


```{r}
# complete_payroll_data <-
#   fread("./Data/nyc_payroll_data_complete.csv")
# # Take Random sample of 10000 rows
# random_data <- nyc_payroll_data[sample(nrow(nyc_payroll_data)),]
# nyc_payroll_data <- randomized_data[1:10000,]
# write.csv(nyc_payroll_data, paste("./Data/", 'nyc_payroll_data.csv'))

#Importing the Dataset
nyc_payroll_data <- read.csv("./Data/nyc_payroll_data.csv")
```

```{r}
print(dim(nyc_payroll_data))
```

```{r}
# Display Columns of the dataset
# Display Columns of the dataset
kable(data.frame(Column_Names = names(nyc_payroll_data)), "markdown")

```

Presented above are the columns of the dataset.

On further examination of the data, we find that there are few inconsistencies in the data:

- The column indicative of the Middle Initial of employees, namely, Mid.Init, does not have explicit NA values. However, it has empty strings such as "", "-" and "." which essentially show empty entries and can be considered as NA values. This conversion needs to be made. 

- "Work.Location.Borough" has different boroughs from different parts of New York State such as Albany, Westchester, Delaware etc. Moreover, Staten Island has been mentioned as Richmond County and Manhattan and Bronx have been mentioned twice, where they differ in capitalization. The data also has empty strings.

For our study, we wish to consider only the 5 boroughs of NYC, namely, Manhattan, Brooklyn, Queens, Bronx and Staten Island. The data needs to be preprocessed for the same. 

- The salaries for employees have not been mentioned on a consistent scale. We have base salaries mentioned per annum, per day, per hour and on a prorated annual basis as well. The scale needs to be consistent for fair comparisons, and we look to convert the data to a "per Day" basis, so as to compare our results with the daily wage. 

- Finally, the data after our preprocessing will contain NA values which need to be dealt with.

The above inconsistencies have been made based on our analysis as seen below. For the sake of clean code, we have excluded the code and analysis for those columns which did not have any inconsistencies.

```{r}
#Analyzing Data to Uncover any Possible Inconsistencies
unique(nyc_payroll_data$Mid.Init)
unique(nyc_payroll_data$Work.Location.Borough)
unique(nyc_payroll_data$Pay.Basis)
```

Apart from handling NA values, the inconsistencies have been dealt with below:

```{r}
# Converting Empty Strings to NA values in "Mid.Init"
nyc_payroll_data$Mid.Init[nyc_payroll_data$Mid.Init==""] <- NA
nyc_payroll_data$Mid.Init[nyc_payroll_data$Mid.Init=="-"] <- NA
nyc_payroll_data$Mid.Init[nyc_payroll_data$Mid.Init=="."] <- NA

# Fixing Issues in "Work.Location.Borough"
nyc_payroll_data$Work.Location.Borough[nyc_payroll_data$Work.Location.Borough==""] <- NA
nyc_payroll_data$Work.Location.Borough[nyc_payroll_data$Work.Location.Borough=="Manhattan"] <- "MANHATTAN"
nyc_payroll_data$Work.Location.Borough[nyc_payroll_data$Work.Location.Borough=="Bronx"] <- "BRONX"
nyc_payroll_data$Work.Location.Borough[nyc_payroll_data$Work.Location.Borough=="RICHMOND"] <- "STATEN ISLAND"

nyc_boroughs <- c("BROOKLYN", "MANHATTAN", "QUEENS", "BRONX", "STATEN ISLAND")
nyc_payroll_data <- nyc_payroll_data[nyc_payroll_data$Work.Location.Borough %in% nyc_boroughs,]

# Making Data Scale Consistent in Base.Salary through Pay.Basis 
# Adding new column "Daily.Salary"

nyc_payroll_data <- nyc_payroll_data[!(nyc_payroll_data$Pay.Basis %in% "Prorated Annual"),]

nyc_payroll_data <- nyc_payroll_data |>
  mutate(
    Daily.Salary = case_when(
      Pay.Basis == "per Hour" ~ Base.Salary * 24,
      Pay.Basis == "per Annum" ~ Base.Salary / 365,
      TRUE ~ Base.Salary
    )
  )
```


We save this data as a CSV and read the cleaned version for the next segment.

```{r}
# write.csv(nyc_payroll_data, "./Data/cleaned_nyc_payroll.csv", row.names = FALSE)
clean_nyc_payroll <- read.csv("./Data/cleaned_nyc_payroll.csv")

```

## Research Plan

* To understand the employee compensation, we can use a histogram to study the distribution of salaries.

* While understanding the distribution of total pay is important, we also plan to see how these salaries are broken down and how various components of these salaries are distributed, using Scatter Plots. 

* We can also use grouped bar charts, to understand these relationships over time.

* Using a heatmap, with the budget as the color scale, we will be able to uncover any biases when it comes to salaries based on boroughs and agencies.

* A Mosaic plot will be ideal to unravel patterns and compare multivariate relationships when it comes to the salaries earned based on the Job Title and the boroughs.

* A faceted scatterplot, or a faceted barplot would help us present insights on how the relationship between overtime pay and the corresponding payroll has evolved over the years.

* Since we can show the boroughs of NYC using an actual map, we plan to categorize an individual's work experience, and then use that to show how their compensation varies in different parts of NYC, w.r.t. their work experience.

* We also aim to analyze the leave status and workforce dynamics. Leave status typically indicates whether an employee is on leave or not, and if so, what type of leave they are on. This information is often valuable for HR and management to understand workforce availability, plan for staffing needs, and monitor employee well-being.

* We also plan to make use of D3 to make some other interactive graphs showing some other relationships.


## Missing Value Analysis

```{r}
colSums(is.na(clean_nyc_payroll)) |> sort(decreasing = TRUE)
```

We see that only one column, namely `Payroll Number` has missing values.

```{r, fig.height=18, fig.width=30}
plot_missing(clean_nyc_payroll, percent = FALSE)
```

As can be seen from the above plot, there are only two patterns which can be observed in our data. The first being the complete lack of NaN values, whereas the second pattern exhibits missing values in one column only, namely, `Payroll Number`.

The graph on the right shows that there are nearly 3000 rows exhibiting the second pattern, and about 7000 points exhibiting the first, where they do not have any missing values at all.

We also get to see which columns have missing values in the form of a bar chart on top, and see that only one column falls under this category.

```{r, message=FALSE, warning=FALSE, fig.height=11}
missing_data.frame(clean_nyc_payroll) |> image()
```

This graph shows us the missing values in the entire dataset. The cells represent the actual values after scaling, defined by each row and column of the actual dataset. Higher values take on the lighter colors, whereas colors close to red represent values which are lower.

The values in black, indicate missing data. Here, we see that `Payroll Number` has missing data for nearly 3000 hundred contiguous rows.
